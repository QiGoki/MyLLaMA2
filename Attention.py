import torch


def repeat_kv(x:torch.Tensor, n_rep:int):
    # 获取输入张量的形状：批量大小、序列长度、键/值对头的数量、每个头的维度大小
    bs, slen, n_kv_heads, head_dim = x.shape

    # 如果重复次数为1，则不需要重复，直接返回原始张量
    if n_rep == 1:
        return x

    # 对张量进行扩展和重塑操作以重复键值对
    return (
        x[:,:,:,None,:] # 在第四个维度（头的维度）前添加一个新的维度
        .expand(bs, slen, n_kv_heads,n_rep, head_dim) # 将新添加的维度扩展到n_rep大小，实现重复的效果
        .reshape(bs, slen, n_kv_heads * n_rep, head_dim) # 重新苏醒，合并键/值对头的数量和重复次数的维度
    )

